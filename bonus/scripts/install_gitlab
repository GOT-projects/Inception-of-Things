#!/bin/bash

# Function to print a message with the index number
print_msg() {
    export IDX=$(expr $IDX + 1)
    echo -e "\033[32m[$IDX] $1\033[0m"
}

uninstall_Metallb(){
  print_msg "Uninstall metallb"
  sudo kubectl delete -f https://raw.githubusercontent.com/metallb/metallb/v0.14.3/config/manifests/metallb-native.yaml
}

install_Metallb(){
  uninstall_Metallb
  print_msg "Install metallb"
  sudo kubectl apply -f https://raw.githubusercontent.com/metallb/metallb/v0.14.3/config/manifests/metallb-native.yaml
  sudo kubectl apply -f ../ConfigMap/.

}

update_helm(){
  print_msg "Install heml"
  sudo helm repo add gitlab https://charts.gitlab.io/
  sudo helm repo update
}


install_gitlab(){
  #install_Metallb
  #update_helm
  sudo kubectl create namespace gitlab
  sudo helm upgrade --install gitlab gitlab/gitlab \
    --namespace gitlab \
    --timeout 600s \
    --set global.hosts.domain=jmilhas \
    --set global.hosts.externalIP=12.12.2.12 \
    --set certmanager-issuer.email=me@example.com \
    --set postgresql.image.tag=13.6.0 \
    --set global.edition=ce
  print_msg "Password gitlab"
  sudo kubectl get secret gitlab-gitlab-initial-root-password -o jsonpath='{.data.password}' | base64 --decode ; echo

}

install_gitlab

